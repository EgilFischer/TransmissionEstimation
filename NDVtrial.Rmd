---
title: "NDVTransmissionTrial"
author: "Egil A.J. Fischer"  
affiliation: "Farm Animal Health, Population Health Sciences, Faculty of Veterinary Medicine, Utrecht Universiteit"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output:
  pdf_document: default
  html_document: default
fig.caption: yes
<!--output: beamer_presentation-->
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#add libraries
library(openxlsx)
library(ggplot2)
#source functions
source("TransmissionExperimentDatamodel.R")
#standard error function
sem <- function(x){sd(x)/sqrt(length(x))}
```

# Short summary
The transmission parameter \(\beta\) (unit = \(day^{-1}\)), reproduction number \(R\) (dimensionless) and the infectious period (unit = \(day\)) for vaccinated and unvaccinated chickens was estimated. 
The vaccination reduced the infectious period and transmission parameter substantially and thus also the reproduction number. The reproduction number was, however, not smaller than 1. This indicates that the vaccination will reduce transmission speed, but cannot prevent an outbreak NDV in this setting. 
Additional measures such as compartimentalization can contribute to further reduction of spread and thus lower the reproduction number.

# Introduction
- Background trial
- Background transmission models

## Objectives
- Estimation of infectious period for vaccinated and unvaccinated
- Estimation of transmission parameter beta for vaccinated and unvaccinated
- Estimation of R0 for vaccinated and unvaccinated

# Material and methods

Four different assumptions were used to estimate the transmission parameter. 
An animal is positive if:
\begin{enumerate}
\item one or both samples are positive
\item both samples are positive
\item the ON sample is positive
\item the CLO sample is positive
\end{enumerate}

For each of these assumptions we estimated the infectious period, the transmission parameter \(\beta\) the basic reproduction number \(\textit{R}_0\). 
The infectious period was estimated assuming that these are normally distributed. 
The transmission parameter \(\beta\) is estimated using the generalized linear model with a complementary loglog-link function: 

`glm(cbind(C, S-C) ~ 1,offset = log(I/N), family = binomial(link = "cloglog"), data = out.nona, na.action = na.omit)`
                 
The basic reproduction number \(\textit{R}_0\) is than estimated by multiplying the \(\beta\) with the mean infectious period. The confidence interval is calculated by $\log(R) = \log(\beta)+\log(T_{inf})\pm Z_{0.05} \cdot (\log(SE(\beta)) +\log(SE(T_{inf}))$, which thus assumes independence between the transmission parameter and the infectious period. 

# Results
## Load and organize data 
The data sets consist of two separate data files in 'xlsx' format. These files need to be combined to form one data set 
```{r include = F }
data.dir <- "C:/Surfdrive/Projecten/CEVA/"
#read the data of the vaccination group
cevadata1A <- read.xlsx(paste0(data.dir,
"P062VectormuneNDtransmissionstudysheddingdata_setA_readible.xlsx"),
                      sheet = "Group1A")
cevadata2A <- read.xlsx(paste0(data.dir, "P062VectormuneNDtransmissionstudysheddingdata_setA_readible.xlsx"),
                        sheet = "Group2A")
cevadata1B <- read.xlsx(paste0(data.dir,
"P062VectormuneNDtransmissionstudysheddingdata_setB_readible.xlsx"),
                      sheet = "Group1B")
cevadata2B <- read.xlsx(paste0(data.dir, "P062VectormuneNDtransmissionstudysheddingdata_setB_readible.xlsx"),
                        sheet = "Group2B")

cevadata <- rbind(cevadata1A,cevadata1B,cevadata2A,cevadata2B)

```

with variables 
```{r}
names(cevadata) 
```


```{r include = F}
#rename to standard
cevadata$ci <- sapply(cevadata$Challenge, FUN = function(x){ifelse(grepl("contact", x),"contact","seeder")})
```

Define a function ``` reform.data ``` to rearrange the data for analyses. The function takes the data and use the names of the sampledays, determine positivity based on one or all positive samples, and define the cutt-off value for positivity. 

## Descriptive data 
### Epidemic curves
```{r, include = FALSE}
data.one.positive <- reform.data(cevadata,
                                sampleday.vars = paste0(c(1:14),".dpch"),
                                positive.if = "max",
                                cut.off = 36)
data.all.positive <- reform.data(cevadata,
                                sampleday.vars = paste0(c(1:14),".dpch"),
                                positive.if = "min",
                                cut.off = 36)

epicurveplot <- ggplot(data = rbind(cbind(data.all.positive[[1]], pos = "All samples positive"),cbind(data.one.positive[[1]], pos = "At least one sample positive" ))) +
  geom_path(aes(x = ndpch, y = I/N, colour = Vaccinated, group = Group))+
  geom_point(aes(x = ndpch, y = I/N, shape =  Group))+
  facet_grid(.~pos)+xlab("Day post inoculation")+ylab("Prevalence (I/N)")

```
```{r, fig.cap = 'Infection curves'}
epicurveplot
```
In some stable all chickens died, so that I/N was "NA" causing a message that these were not plotted.
The vaccinated groups are found all to be positive in both swaps (CLO swab and NO swab), while non of the unvaccinated were positive. 

The separate swabs represent the following epidemic curves:

```{r, include = FALSE}
data.ON.positive <- reform.data(cevadata[cevadata$Sample == "ON swab",],
                                sampleday.vars = paste0(c(1:14),".dpch"),
                                positive.if = "max",
                                cut.off = 36)
data.CLO.positive <- reform.data(cevadata[cevadata$Sample == "CLO swab",],
                                sampleday.vars = paste0(c(1:14),".dpch"),
                                positive.if = "min",
                                cut.off = 36)

epicurveplot <- ggplot(data = rbind(cbind(data.ON.positive[[1]], pos = "ON swab"),cbind(data.CLO.positive[[1]], pos = "CLO swab" ))) +
  geom_path(aes(x = ndpch, y = I/N, colour = Vaccinated, group = Group))+
  geom_point(aes(x = ndpch, y = I/N, shape =  Group))+
  facet_grid(.~pos)+xlab("Day post inoculation")+ylab("Prevalence (I/N)")

```
```{r, fig.cap = 'Infection curves'}
epicurveplot
```
On first sight the curves are similar for the unvaccinated groups, but the CLO swab are less likely and later positive than the ON swab in the vaccinated groups.

# Transmission parameters
At the end of this section all results will be summarized.
```{r}
all.results <- NULL

```

## One positive sample

### Infectious period 
```{r, include = F}
out.indiv<- data.one.positive[[2]];
out.indiv$infper <- apply(data.one.positive[[2]][,c(5:18)], 1,sum, na.rm = T);
```

```{r }
#visualize
ggplot(data = out.indiv) +
  geom_histogram(aes(x = infper, y = ..density.., fill = Vaccinated),
                 position = "dodge",binwidth = 1)+
  ggtitle("Distribution of infectious period with at least one sample pos")+
  xlab("Infectious period") 

ggplot(data = out.indiv) +
  geom_histogram(aes(x = infper, y = ..density.., fill = Vaccinated),
                 position = "dodge",binwidth = 1)+
  ggtitle("Distribution of infectious period with at least one sample pos")+
  xlab("Infectious period") +facet_grid(.~Challenge)
```
```{r include =F}
#descriptive statistics overall
overall <- cbind(mean(out.indiv$infper), sd(out.indiv$infper))
mean <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),mean)
sd <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),sd)
group <- c("Overall", "Unvaccinated", "Vaccinated")
table.infper <- data.frame(Group = group, 
                           Mean = rbind(overall[1,1],
                                        mean[mean$Group.1 =="No",2],
                                        mean[mean$Group.1 =="Yes",2] ),
                           SD = rbind(overall[1,2],sd[sd$Group.1 =="No",2],
                                      sd[sd$Group.1 =="Yes",2] ))

```
Descriptive statistics for the infectious period.
```{r}
table.infper
```
From the table it already seems that the variances are not equal. Therefor we first test for equality of variance and than do the appropriate test to compare means.

```{r}
#test for equal variances
fligner.test(out.indiv$infper, out.indiv$Vaccinated) 
#Compare the mean infectious period
t.test(out.indiv$infper~out.indiv$Vaccinated,var.equal = FALSE) 
#Compare the sd infectious period
var.test(out.indiv$infper~out.indiv$Vaccinated)
```

The vaccinated group has a lower mean infectious period, but a larger variance. 

#### Separate Seeder and contact birds

```{r include =F}
#descriptive statistics overall
overall <- cbind(mean(out.indiv$infper), sd(out.indiv$infper))
mean <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated, out.indiv$Challenge),mean)
sd <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated, out.indiv$Challenge),sd)
group <- c("Overall", mean[,1])
challenge <- c("Overall", mean[,2])
table.infper <- data.frame(Vaccination = group, 
                           Challenge = challenge,
                           Mean = c(overall[1,1],
                                        mean[,3]
                                        ),
                           SD = c(overall[1,2],sd[,3]))

```
Descriptive statistics for the infectious period.
```{r}
table.infper
```
From the table it already seems that the variances are not equal. Therefor we first test for equality of variance and than do the appropriate test to compare means.

```{r}
#test for equal variances 
#vaccinated vs unvaccinated
fligner.test(out.indiv$infper, out.indiv$Vaccinated) 
#seeder vs contact
fligner.test(out.indiv$infper, out.indiv$Challenge) 
#all four groups
fligner.test(out.indiv$infper, mapply(paste0,out.indiv$Challenge,out.indiv$Vaccinated)) 
```
Variances between vaccine groups are not equal. Between challenge groups there are no differences.
```{r}
#Compare the mean infectious period
"vaccinated versus unvaccinated"
t.test(out.indiv$infper~out.indiv$Vaccinated,var.equal = FALSE) 
"seeder versus contact"
t.test(out.indiv$infper~out.indiv$Challenge,var.equal = FALSE) 
"vaccinated versus unvaccinated in contacts"
t.test(infper~Vaccinated ,
       data = out.indiv[out.indiv$Challenge == "contact", ],
       var.equal = FALSE) 
"vaccinated versus unvaccinated in seeders"
t.test(infper~Vaccinated ,
       data = out.indiv[out.indiv$Challenge == "seeder", ],
       var.equal = FALSE)
#Compare the sd infectious period
var.test(out.indiv$infper~out.indiv$Vaccinated)
```



### Transmission parameters \(\beta\) 
```{r include = F} 
out.nona <- data.one.positive[[1]][(!is.na(data.one.positive[[1]]$S)&!is.na(data.one.positive[[1]]$C) &data.one.positive[[1]]$I>0 &data.one.positive[[1]]$S>0),]

```

```{r}
#test glm
fit.full <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Vaccinated+
                  out.nona$Group,
                offset = log(out.nona$I/out.nona$N),
                family = binomial(link = "cloglog"), data = out.nona, na.action = na.omit)
drop1(fit.full)
```
In backward selection Group falls out, but vaccination stays in.
```{r }
fit.empty <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~1,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"),
                 data = out.nona, 
                 na.action = na.omit)
add1(fit.empty, ~. + out.nona$Vaccinated + out.nona$Group)

fit.vac <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~out.nona$Vaccinated,
               offset = log(out.nona$I/out.nona$N), 
               family = binomial(link = "cloglog"),
               data = out.nona, na.action = na.omit)
add1(fit.vac, scope = ~.+na.omit(out.nona$Group))

fit.group <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~out.nona$Group,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, na.action = na.omit)
add1(fit.group, ~.+out.nona$Vaccinated)


```
In forward selection both groups and vaccination are added as single terms to improve the empty model, but the addition of Group in the vaccine model or vaccination in the group model shows that Group should not be included in the model.

```{r, include = F}
profile.confint <- confint(fit.vac);
#beta's
beta.table<- data.frame(rbind(cbind( beta = exp(fit.vac$coefficients[[1]]), t(exp(profile.confint[1,]))),
cbind( beta = exp(fit.vac$coefficients[[1]]+fit.vac$coefficients[[2]]), t(exp(profile.confint[2,]+fit.vac$coefficients[[1]])))));
colnames(beta.table)<- c("beta","2.5%","97.5")
```
```{r}
summary(fit.vac)
```
Vaccination lowers the infeection parameter \(\beta\).
```{r}
beta.table

```

### Basic reproduction number \(R_0\)
```{r, include = F}
#calculate R0
alpha = 0.05 #conf.level
#beta
mean.logbeta <- summary(fit.vac)$coefficients[,1] 
se.logbeta<- summary(fit.vac)$coefficients[,2]

#infectious period
mean.inf.per<- aggregate(out.indiv$infper, list(out.indiv$Vaccinated, out.indiv$Challenge),mean)
sem.inf.per <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated,  out.indiv$Challenge),sem)
mean.log.inf.per <- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated, out.indiv$Challenge),mean)
sem.log.inf.per<- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated, out.indiv$Challenge),sem)
#R0
mean.R0 <- data.frame(Vaccinated = c("No","Yes"),
                      beta = exp(c(mean.logbeta[1],sum(mean.logbeta))),
                      llbeta = exp(profile.confint[,1]+c(0,mean.logbeta[1])),
                      ulbeta = exp(profile.confint[,2]+c(0,mean.logbeta[1])),
                      infper = mean.inf.per$x,
                      llinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = T)*sem.inf.per$x,
                      ulinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = F)*sem.inf.per$x,
                      logR0 = c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x,
                      lllogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = T)*(se.logbeta + sem.log.inf.per$x),
                      ullogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = F)*(se.logbeta + sem.log.inf.per$x))
                      

mean.R0$R <- exp(mean.R0$logR0)
mean.R0$llR <- exp(mean.R0$lllogR0)
mean.R0$ulR <- exp(mean.R0$ullogR0)
```
```{r}
mean.R0[, c(1,2,3,4)]
mean.R0[, c(1,5,6,7)]
mean.R0[, c(1,11,12,13)]
```
Based on the assumption of one of both samples required to be positive, we find that the transmission parameter \(\beta\) and the mean infectious period are lower, which results in a reproduction number \(R\) which is more than 4 times smaller, but is not lower than the threshold \(R \leq 1\). 

For all other options I have until now only used the overall infectious period!!!

```{r include = F}
all.results <- rbind(all.results, cbind(Assumption = "OneOrBoth", mean.R0))

```


## Both positive samples
### Infectious period
```{r, include = F}
out.indiv<- data.all.positive[[2]];
out.indiv$infper <- apply(data.all.positive[[2]][,c(5:18)], 1,sum, na.rm = T);
```

```{r }
#visualize
ggplot(data = out.indiv) +
  geom_histogram(aes(x = infper, y = ..density.., fill = Vaccinated),
                 position = "dodge",binwidth = 1)+
  ggtitle("Distribution of infectious period with both samples pos")+
  xlab("Infectious period") 


ggplot(data = out.indiv) +
  geom_histogram(aes(x = infper, y = ..density.., fill = Vaccinated),
                 position = "dodge",binwidth = 1)+
  ggtitle("Distribution of infectious period with at least one sample pos")+
  xlab("Infectious period") +facet_grid(.~Challenge)
```
```{r include =F}
#descriptive statistics
overall <- cbind(mean(out.indiv$infper), sd(out.indiv$infper))
mean <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),mean)
sd <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),sd)
group <- c("Overall", "Unvaccinated", "Vaccinated")
table.infper <- data.frame(Group = group, 
                           Mean = rbind(overall[1,1],
                                        mean[mean$Group.1 =="No",2],
                                        mean[mean$Group.1 =="Yes",2]),
                           SD = rbind(overall[1,2],
                                      sd[sd$Group.1 =="No",2],
                                      sd[sd$Group.1 =="Yes",2] ))
```
Descriptive statistics for the infectious period.
```{r}
table.infper
```

Using the assumption that both swabs need a positive result, the vaccinated group is never infectious. 
#### Separate Seeder and contact birds

```{r include =F}
#descriptive statistics overall
overall <- cbind(mean(out.indiv$infper), sd(out.indiv$infper))
mean <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated, out.indiv$Challenge),mean)
sd <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated, out.indiv$Challenge),sd)
group <- c("Overall", mean[,1])
challenge <- c("Overall", mean[,2])
table.infper <- data.frame(Vaccination = group, 
                           Challenge = challenge,
                           Mean = c(overall[1,1],
                                        mean[,3]
                                        ),
                           SD = c(overall[1,2],sd[,3]))

```
Descriptive statistics for the infectious period.
```{r}
table.infper
```
From the table it already seems that the variances are not equal. Therefor we first test for equality of variance and than do the appropriate test to compare means.

```{r}
#test for equal variances 
#vaccinated vs unvaccinated
fligner.test(out.indiv$infper, out.indiv$Vaccinated) 
#seeder vs contact
fligner.test(out.indiv$infper, out.indiv$Challenge) 
#all four groups
fligner.test(out.indiv$infper, mapply(paste0,out.indiv$Challenge,out.indiv$Vaccinated)) 
```

```{r}


#Compare the mean infectious period
"vaccinated versus unvaccinated"
t.test(out.indiv$infper~out.indiv$Vaccinated,var.equal = FALSE) 
"seeder versus contact"
t.test(out.indiv$infper~out.indiv$Challenge,var.equal = FALSE) 
"vaccinated versus unvaccinated in contacts"
t.test(infper~Vaccinated ,
       data = out.indiv[out.indiv$Challenge == "contact", ],
       var.equal = FALSE) 
"vaccinated versus unvaccinated in seeders"
t.test(infper~Vaccinated ,
       data = out.indiv[out.indiv$Challenge == "seeder", ],
       var.equal = FALSE)
#Compare the sd infectious period
var.test(out.indiv$infper~out.indiv$Vaccinated)
```

### Transmission parameters \(\beta\) 
```{r include = F} 
out.nona <- data.all.positive[[1]][(!is.na(data.all.positive[[1]]$S)&!is.na(data.all.positive[[1]]$C) &data.all.positive[[1]]$I>0 &data.all.positive[[1]]$S>0),]

```
Because there are no chickens that are set to infectious based on the criterium that both need to be positive, parameters can only be estimated for the unvaccinated group. 
```{r }
#test glm
fit.full <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Group, 
                offset = log(out.nona$I/out.nona$N), 
                family = binomial(link = "cloglog"), 
                data = out.nona, na.action = na.omit)
drop1(fit.full)
```
In backward selection again Group falls out.

```{r }
fit.empty <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~1,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, 
                 na.action = na.omit)
add1(fit.empty, ~. +  out.nona$Group)


```
Also in forward selection,  Group should not be included in the model.

```{r, include = F}
profile.confint <- confint(fit.empty);
#beta's
beta.table<- data.frame(cbind( beta = exp(fit.empty$coefficients[[1]]), t(exp(profile.confint))));
colnames(beta.table)<- c("beta","2.5%","97.5")
```
```{r}
summary(fit.empty)
```
Vaccination lowers the infeection parameter \(\beta\).
```{r}
beta.table

```

### Basic reproduction number \(R_0\)
```{r, include = F}
#calculate R0
alpha = 0.05 #conf.level
#beta
mean.logbeta <- summary(fit.vac)$coefficients[,1] 
se.logbeta<- summary(fit.vac)$coefficients[,2]

#infectious period
mean.inf.per<- aggregate(out.indiv$infper, list(out.indiv$Vaccinated, out.indiv$Challenge),mean)
sem.inf.per <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated,  out.indiv$Challenge),sem)
mean.log.inf.per <- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated, out.indiv$Challenge),mean)
sem.log.inf.per<- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated, out.indiv$Challenge),sem)
#R0
mean.R0 <- data.frame(Vaccinated = c("No","Yes"),
                      beta = exp(c(mean.logbeta[1],sum(mean.logbeta))),
                      llbeta = exp(profile.confint[1]+c(0,mean.logbeta[1])),
                      ulbeta = exp(profile.confint[2]+c(0,mean.logbeta[1])),
                      infper = mean.inf.per$x,
                      llinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = T)*sem.inf.per$x,
                      ulinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = F)*sem.inf.per$x,
                      logR0 = c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x,
                      lllogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = T)*(se.logbeta + sem.log.inf.per$x),
                      ullogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = F)*(se.logbeta + sem.log.inf.per$x))
    

mean.R0$R <- exp(mean.R0$logR0)
mean.R0$llR <- exp(mean.R0$lllogR0)
mean.R0$ulR <- exp(mean.R0$ullogR0)                  

```

```{r}
mean.R0[, c(1,2,3,4)]
mean.R0[, c(1,5,6,7)]
mean.R0[, c(1,11,12,13)]
```
 
```{r include = F}
all.results <- rbind(all.results, cbind(Assumption = "Both", mean.R0))

```

## ON sample positive
### Infectious period
```{r, include = F}
out.indiv<- data.ON.positive[[2]];
out.indiv$infper <- apply(data.ON.positive[[2]][,c(5:18)], 1,sum, na.rm = T);
```

```{r }
#visualize
ggplot(data = out.indiv) +
  geom_histogram(aes(x = infper, y = ..density.., fill = Vaccinated), 
                 position = "dodge",binwidth = 1)+
  ggtitle("Distribution of infectious period with ON sample pos")+
  xlab("Infectious period") 
```
```{r include =F}
#descriptive statistics
overall <- cbind(mean(out.indiv$infper), sd(out.indiv$infper))
mean <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),mean)
sd <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),sd)
group <- c("Overall", "Unvaccinated", "Vaccinated")
table.infper <- data.frame(Group = group, 
                           Mean = rbind(overall[1,1],
                                        mean[mean$Group.1 =="No",2],
                                        mean[mean$Group.1 =="Yes",2]),
                           SD = rbind(overall[1,2],sd[sd$Group.1 =="No",2],
                                      sd[sd$Group.1 =="Yes",2] ))
```
Descriptive statistics for the infectious period.
```{r}
table.infper
```
From the table it already seems that the variances are not equal. Therefor we first test for equality of variance and than do the appropriate test to compare means.

```{r}
#test for equal variances
fligner.test(out.indiv$infper, out.indiv$Vaccinated) #conclude unequal variances
#Compare the mean infectious period
t.test(out.indiv$infper~out.indiv$Vaccinated,var.equal = FALSE) 
#Compare the sd infectious period
var.test(out.indiv$infper~out.indiv$Vaccinated)
```

The vaccinated group has a lower mean infectious period, but a larger variance. 

### Transmission parameters \(\beta\) 
```{r include = F} 
out.nona <- data.ON.positive[[1]][(!is.na(data.ON.positive[[1]]$S)&!is.na(data.ON.positive[[1]]$C) &data.ON.positive[[1]]$I>0 &data.ON.positive[[1]]$S>0),]

```

```{r }
#test glm
fit.full <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Vaccinated +out.nona$Group, 
                offset = log(out.nona$I/out.nona$N), 
                family = binomial(link = "cloglog"), 
                data = out.nona, na.action = na.omit)
drop1(fit.full)

fit.vac <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Vaccinated, 
               offset = log(out.nona$I/out.nona$N), 
               family = binomial(link = "cloglog"), 
               data = out.nona, na.action = na.omit)
drop1(fit.vac)

fit.group <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Group, 
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, na.action = na.omit)
drop1(fit.group)
```
In backward selection either group or vaccination should stay in the selection.

```{r }
fit.empty <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~1,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, na.action = na.omit)
add1(fit.empty, ~. + out.nona$Vaccinated + out.nona$Group)

fit.vac <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~out.nona$Vaccinated,
               offset = log(out.nona$I/out.nona$N), 
               family = binomial(link = "cloglog"), 
               data = out.nona, na.action = na.omit)
add1(fit.vac, scope = ~.+na.omit(out.nona$Group))

fit.group <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~out.nona$Group,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, 
                 na.action = na.omit)
add1(fit.group, ~.+out.nona$Vaccinated)


```
In forward selection either groups or vaccination are added as single terms to improve the empty model. We choose to use vaccination as this is the main interest.

```{r, include = F}
profile.confint <- confint(fit.vac);
#beta's
beta.table<- data.frame(rbind(cbind( beta = exp(fit.vac$coefficients[[1]]), t(exp(profile.confint[1,]))),
cbind( beta = exp(fit.vac$coefficients[[1]]+fit.vac$coefficients[[2]]), t(exp(profile.confint[2,]+fit.vac$coefficients[[1]])))));

beta.table <- cbind(Vaccination = c("No","Yes") ,beta.table)
colnames(beta.table)<- c("Vaccination","beta","2.5%","97.5")
```
```{r}
summary(fit.vac)
```
Vaccination lowers the infection parameter \(\beta\).
```{r}
beta.table

```
The transmission parameter \(\beta\) is lower for the vaccinated group.

### Basic reproduction number \(R_0\)
```{r, include = F}
#calculate R0
alpha = 0.05 #conf.level
#beta
mean.logbeta <- summary(fit.vac)$coefficients[,1] 
se.logbeta<- summary(fit.vac)$coefficients[,2]

#infectious period
mean.inf.per<- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),mean)
sem.inf.per <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),sd)$x/sqrt(c(sum(out.indiv$Vaccinated =="No"), sum(out.indiv$Vaccinated =="Yes")))
mean.log.inf.per <- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated),mean)
sem.log.inf.per<- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated),sd)$x/sqrt(c(sum(out.indiv$Vaccinated =="No"), sum(out.indiv$Vaccinated =="Yes")))
#R0
mean.R0 <- data.frame(Vaccinated = c("No","Yes"),
                      beta = exp(c(mean.logbeta[1],sum(mean.logbeta))),
                      llbeta = exp(profile.confint[,1]+c(0,mean.logbeta[1])),
                      ulbeta = exp(profile.confint[,2]+c(0,mean.logbeta[1])),
                      infper = mean.inf.per$x,
                      llinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = T)*sem.inf.per,
                      ulinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = F)*sem.inf.per,
                      logR0 = c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x,
                      lllogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = T)*(se.logbeta + sem.log.inf.per),
                      ullogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = F)*(se.logbeta + sem.log.inf.per)
                      )

mean.R0$R <- exp(mean.R0$logR0)
mean.R0$llR <- exp(mean.R0$lllogR0)
mean.R0$ulR <- exp(mean.R0$ullogR0)
```
```{r}
mean.R0[, c(1,2,3,4)]
mean.R0[, c(1,5,6,7)]
mean.R0[, c(1,11,12,13)]
```
Based on the assumption of ON samples required to be positive, we find that the transmission parameter \(\beta\) and the mean infectious period are lower, which results in a reproduction number \(R\) which is less than one thirth, but is not lower than the threshold \(R \leq 1\). 

```{r include = F}
all.results <- rbind(all.results, cbind(Assumption = "ON sample", mean.R0))

```

## CLO sample positive
### Infectious period 

```{r, include = F}
out.indiv<- data.CLO.positive[[2]];
out.indiv$infper <- apply(data.CLO.positive[[2]][,c(5:18)], 1,sum, na.rm = T);
```

```{r }
#visualize
ggplot(data = out.indiv) +
  geom_histogram(aes(x = infper, y = ..density.., fill = Vaccinated), 
                 position = "dodge",binwidth = 1)+
  ggtitle("Distribution of infectious period with CLO sample pos")+
  xlab("Infectious period") 
```
```{r include =F}
#descriptive statistics
overall <- cbind(mean(out.indiv$infper), sd(out.indiv$infper))
mean <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),mean)
sd <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),sd)
group <- c("Overall", "Unvaccinated", "Vaccinated")
table.infper <- data.frame(Group = group, 
                           Mean = rbind(overall[1,1],
                                        mean[mean$Group.1 =="No",2],
                                        mean[mean$Group.1 =="Yes",2] ),
                           SD = rbind(overall[1,2],
                                      sd[sd$Group.1 =="No",2],
                                      sd[sd$Group.1 =="Yes",2] ))
```
Descriptive statistics for the infectious period.
```{r}
table.infper
```
From the table it already seems that the variances are not equal. Therefor we first test for equality of variance and than do the appropriate test to compare means.

```{r}
#test for equal variances
fligner.test(out.indiv$infper, out.indiv$Vaccinated) 
#Compare the mean infectious period
t.test(out.indiv$infper~out.indiv$Vaccinated,var.equal = F) 
t.test(out.indiv$infper~out.indiv$Vaccinated,var.equal = T) 

```

The vaccinated group has a lower mean infectious period, but no difference in variance found. 


### Transmission parameters \(\beta\) 
```{r include = F} 
out.nona <- data.CLO.positive[[1]][(!is.na(data.CLO.positive[[1]]$S)&!is.na(data.CLO.positive[[1]]$C) &data.CLO.positive[[1]]$I>0 &data.CLO.positive[[1]]$S>0),]

```

```{r }
#test glm
fit.full <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Vaccinated +out.nona$Group, 
                offset = log(out.nona$I/out.nona$N), 
                family = binomial(link = "cloglog"), 
                data = out.nona, 
                na.action = na.omit)
drop1(fit.full)

fit.vac <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Vaccinated, 
               offset = log(out.nona$I/out.nona$N), 
               family = binomial(link = "cloglog"), 
               data = out.nona, 
               na.action = na.omit)
drop1(fit.vac)

fit.group <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~ out.nona$Group, 
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, 
                 na.action = na.omit)
drop1(fit.group)
```
In backward selection either group or vaccination should stay in the selection.

```{r }
fit.empty <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~1,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, 
                 na.action = na.omit)
add1(fit.empty, ~. + out.nona$Vaccinated + out.nona$Group)

fit.vac <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~out.nona$Vaccinated,
               offset = log(out.nona$I/out.nona$N), 
               family = binomial(link = "cloglog"), 
               data = out.nona, 
               na.action = na.omit)
add1(fit.vac, scope = ~.+na.omit(out.nona$Group))

fit.group <- glm(cbind(out.nona$C, out.nona$S-out.nona$C) ~out.nona$Group,
                 offset = log(out.nona$I/out.nona$N), 
                 family = binomial(link = "cloglog"), 
                 data = out.nona, 
                 na.action = na.omit)
add1(fit.group, ~.+out.nona$Vaccinated)


```
In forward selection either groups or vaccination are added as single terms to improve the empty model. We choose to use vaccination as this is the main interest.

```{r, include = F}
profile.confint <- confint(fit.vac);
#beta's
beta.table<- data.frame(rbind(cbind( beta = exp(fit.vac$coefficients[[1]]), t(exp(profile.confint[1,]))),
cbind( beta = exp(fit.vac$coefficients[[1]]+fit.vac$coefficients[[2]]), t(exp(profile.confint[2,]+fit.vac$coefficients[[1]])))));

beta.table <- cbind(Vaccination = c("Yes","No") ,beta.table)
colnames(beta.table)<- c("Vaccination","beta","2.5%","97.5")
```
```{r}
summary(fit.vac)
```
Vaccination lowers the infection parameter \(\beta\), but this not statistically significant.
```{r}
beta.table

```
The transmission parameter \(\beta\) is lower for the vaccinated group, but the confidence intervals overlap largely.

### Basic reproduction number \(R_0\)
```{r, include = F}
#calculate R0
alpha = 0.05 #conf.level
#beta
mean.logbeta <- summary(fit.vac)$coefficients[,1] 
se.logbeta<- summary(fit.vac)$coefficients[,2]

#infectious period
mean.inf.per<- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),mean)
sem.inf.per <- aggregate(out.indiv$infper, list(out.indiv$Vaccinated),sd)$x/sqrt(c(sum(out.indiv$Vaccinated =="No"), sum(out.indiv$Vaccinated =="Yes")))
mean.log.inf.per <- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated),mean)
sem.log.inf.per<- aggregate(log(sapply(out.indiv$infper,function(x){max(x,.5)})), list(out.indiv$Vaccinated),sd)$x/sqrt(c(sum(out.indiv$Vaccinated =="No"), sum(out.indiv$Vaccinated =="Yes")))
#R0
mean.R0 <- data.frame(Vaccinated = c("No","Yes"),
                      beta = exp(c(mean.logbeta[1],sum(mean.logbeta))),
                      llbeta = exp(profile.confint[,1]+c(0,mean.logbeta[1])),
                      ulbeta = exp(profile.confint[,2]+c(0,mean.logbeta[1])),
                      infper = mean.inf.per$x,
                      llinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = T)*sem.inf.per,
                      ulinfper =  mean.inf.per$x+qnorm(alpha/2,lower.tail = F)*sem.inf.per,
                      logR0 = c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x,
                      lllogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = T)*(se.logbeta + sem.log.inf.per),
                      ullogR0 = (c(mean.logbeta[1]  ,sum(mean.logbeta))+mean.log.inf.per$x) + qnorm(alpha/2,lower.tail = F)*(se.logbeta + sem.log.inf.per)
                      )

mean.R0$R <- exp(mean.R0$logR0)
mean.R0$llR <- exp(mean.R0$lllogR0)
mean.R0$ulR <- exp(mean.R0$ullogR0)
```
```{r}
mean.R0[, c(1,2,3,4)]
mean.R0[, c(1,5,6,7)]
mean.R0[, c(1,11,12,13)]
```
Based on the assumption of CLO samples required to be positive, we find that the transmission parameter \(\beta\) and the mean infectious period are lower, although teh transmission parameter is not statistically significant.  The reproduction number \(R\) is one nineth, and lower than the threshold \(R < 1\) although the confidence interval incorporates 1. 

```{r include = F}
all.results <- rbind(all.results, cbind(Assumption = "CLO sample", mean.R0))

```
# Graphic summary of results
```{r include = F}
#remove section line for "Both" to clean up
if(length(all.results[,1]) == 12){all.results <- all.results[c(1,2,3,4,5,7,9,10,11,12),]}
rownames(all.results)<- NULL
all.results$Challenge <- c("Contact","Contact","Seeder","Seeder","Contact","Seeder","Seeder & Contact","Seeder & Contact","Seeder & Contact","Seeder & Contact")
```
## Infectious period
```{r}
ggplot(data = all.results) + 
  geom_point(aes(x = Assumption, y =infper,colour = Assumption, shape = Challenge ))+
  geom_errorbar(aes( x = Assumption, ymin = llinfper, ymax = ulinfper,colour = Assumption ))+
  facet_grid(.~Vaccinated)+ylab("Infectious period")

```
The descrepancy between the OneOrBoth  and ON/CLO sample is that for the OneOrBoth only contact animals are given. 

## Transmission parameter \(\beta\)
```{r}
ggplot(data = all.results) + 
  geom_point(aes(x = Assumption, y = beta,colour = Assumption, shape = Challenge ))+
  geom_errorbar(aes( x = Assumption, ymin = llbeta, ymax = ulbeta,colour = Assumption ))+
  facet_grid(.~Vaccinated)+ylab("Transmission parameter beta")

```
## Reproduction number \(R\)
```{r}
ggplot(data = all.results) + 
  geom_point(aes(x = Assumption, y = R,colour = Assumption, shape = Challenge ))+
  geom_errorbar(aes( x = Assumption, ymin = llR, ymax = ulR,colour = Assumption ))+
  facet_grid(.~Vaccinated)+ylab("Transmission parameter beta")+scale_y_continuous(breaks = c(0,1,2,5,10))

```

# Conclusions

